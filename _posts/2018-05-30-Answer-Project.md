---
layout: post_layout
title: 夭折的答题王--对战模块
time: On Wednesday, May 30, 2018
location: BeiJing
pulished: true
excerpt_separator: "```"
---

#### 夭折的答题王--对战模块

* 此项目不错，夭折原因并非技术，所以在此想记录下在开发过程中的一些思考

* 对战模块（此模块逻辑比较复杂，主记此模块）
    * 1、AI对战页：当前赛季信息、用户的信息、所有段位列表（前端判断要展示多少）
    * 2、等待对战：拿用户信息
    * 3、对战中：
        * 好友对战：查找5个题目（取AI规则里的一条即可
        * AI对战：查找5个题目（按难易程度）
    * 4、答完题要传连胜次数
    * 5、答题时要把用户的连胜次数查出

* 问题：
    * 如何查题？
    * 如何把查出来的题目精确的给到对应的两个对战人？
    * 难易程度？
    * 注意：AI对战时，和好友对战的查题方式一样，答题时不一样。
        * 答题时，需要按规则把答题的时间给出，答题时把要错误的题id也给出，前端随即选一个错误答案即可或者后台给出也一样，遍历一次这5道题，给出AI错误答案塞进去即可

### 解决思路：
* 一、查题思路：
    * 1、把数据库里的题，按难易程度分类查出id集合，放入redis中（暂设5min缓存）
    * 2、按段位答题占比规则，随机出5个题目id，组成为id集合
    * 3、按id集合查题返出去
    * 4、如果是AI的话，查出AI答题时间范围，AI答错题的数量，在id集合里随机出来，告诉前端这几个题是答错的，选哪个由前端随机控制
    * 5、请求查题时，要把和谁对战传过来判断
    * 6、好友点击链接，查题时，查找他们是不是好友，不是的话加好友

* 二、查出题精准分配：
    * 1、如果是和AI对战的话，请求时直接返回题目就行，不用存redis里了，因为AI的答题时间和哪些答错都返回了
    * 2、和好友对战：
        * key--value
        * key：发起人id+接受人id
        * value：查出的题目
    * 3、当好友接受时，再请求查题，这样可防止邀请了之后，好友没接受在redis里产生的垃圾数据，前端每秒请求一次（判断有无uid确定是否是第一次进入，第一次登录进来，请求首页接口）
    * 4、答题结束后，要请求答题情况接口（把用户答题情况记录下来，并清空用户和好友的题目key）

* 三、答题时：（如何让对手知道你答的是什么）--和好友答题
    * 1、在redis里，存key--value--ok
        * key：发起人+接受人+题目id
        * value：答题时间+回答id
    * 2、获取对手的答题情况--每秒请求一次
        * key换为 接受人+发起人+题目id，获取成功后删除key，返回，请前端处理
    * 3、和AI答题
        * 自己答就行，前端计算
        * AI答题情况，在返回题目时就已经给出了，由前端判断

* 四、和好友对战前建立等待关系
    * 1、uid-waiting作为key，value=0，放入redis中，分享了好多链接，谁点了就和谁对战，只能和一人对战
    * 2、好友点对战：
        * 1）先查uid-waiting是否为空，为空链接失效
        * 2）为1已经在作战，您来迟了
        * 3）为0好友加入对战，此时好友已有fid，uid-waiting的value置为1，返回成功，此时可以请求好友对战的题目了(这就可以满足好友先请求题目了)
    * 3、好友第一次进入（需要得到openid来判断），走首页里的入库逻辑，前端不用弹出奖励了，默默加上就ok了
        * 走首页接口，会得到uid，存起来，下次请求对战链接时，按fid参数传入即可

* 五、对战完成时，加逻辑
    * 1、答题结束时请求--答题情况提交（分析数据）
        * 之前逻辑上外加逻辑：ai不变；好友对战，把uid-waiting从redis里删除--ok
    * 2、结束对战--ai没有，好友对战中，答题完后有结束对战（返回到主页面）和继续对战（下面逻辑）
    * 3、继续对战
        * ai不变
        * 好友：等待（点击继续对战）和加入的过程
        * 点击继续对战的人，变为主动者uid，好友fid----请求我的题目
        * 加入的人----请求好友的题目

* 六、添加好友时思路：
    * 1、之前想过好友只加一条记录就算好友，但这样查询好友时一点都不方便，查询是否是好友时，还需要or来查询，这样效率很低
    * 2、换一种，只要是加好友，就直接加两条，在事务里，查的时候，也就方便多了

